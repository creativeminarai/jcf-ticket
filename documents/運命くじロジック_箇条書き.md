# イベント日付ID対応バッチ生成プロセスのフロー図

以下は、イベント日付ID対応バッチ生成プロセスの流れを説明したシーケンス図です。このプロセスは主に以下のフェーズで構成されています。

## 1. バッチキュー作成フェーズ
- ユーザー/システムがバッチ生成リクエスト（event_id, event_date_id指定）を送信
- バッチキューが作成され、キューIDが発行される
- 初期ステータスは "pending"

## 2. 参加店舗確認フェーズ
- イベントとイベント日付の存在を確認
- 指定されたイベントIDとイベント日付IDに基づいて有効な参加店舗を検索
- 検索条件: deleted_at IS NULL、指定イベントID、指定イベント日付ID

## 3. バッチ作成フェーズ
- 参加店舗の情報と比重を取得
- 新たなバッチを作成（ステータス: "pending"、バッチサイズ: 比重合計）
- キュー情報を更新（ステータス: "processing"、バッチID登録、処理時刻記録）

## 4. チケット生成フェーズ
- 店舗ごとのチケット数を計算
- チケットを一括生成（各参加店舗の比重に応じて）
- 初期ステータス: "pending"、is_drawn: false

## 5. バッチ有効化フェーズ
- チケットをシャッフル（fate_position設定、ステータスを "active" に更新）
- バッチのステータスを "active" に更新し、有効化時刻を記録

## 6. キュー完了フェーズ
- バッチ有効化完了をキューに通知
- キューのステータスを "completed" に更新

## 7. 抽選フェーズ（ユーザー操作）
- ユーザーがくじ引き操作を実行
- チケット状態を更新（is_drawn: true、ユーザーID記録、抽選時刻記録）
- 抽選結果をユーザーに表示

## 8. チケット使用状況確認と次バッチ生成判断
- 残チケット数を確認（指定イベントID、イベント日付IDに関連するチケット）
- システム設定から閾値を確認
- 残チケット数が閾値以下の場合、新バッチ生成プロセスを開始
- それ以外の場合は通常運用を継続

## 9. バッチ完了フェーズ
- すべてのチケットが使用済みになると、バッチのステータスを "completed" に更新
- 完了時刻を記録

このフローでは、イベント日付IDを考慮したバッチ生成が実装されており、特定のイベント日に対応したチケットを効率的に管理できるようになっています。